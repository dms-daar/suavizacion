<html>
<head>

<script src="js/conf.js"></script>
<script src="js/functions.js"></script>
<script src="js/interactive.js"></script>
<script src="js/reporting.js"></script>
<script src="js/utilities.js"></script>

<script text="javascript">

var oScript = new ActiveXObject("StudioCommon.ScriptHelper");
oScript.initialize(window);
var oDmApp = oScript.getApplication();

var SHELL = new ActiveXObject("WSCRIPT.SHELL");
var FSO = new ActiveXObject("Scripting.FileSystemObject");

var PROJECT_FOLDER = oDmApp.ActiveProject.Folder.split('\\').join('/');
var TEMP_FOLDER = PROJECT_FOLDER + "\\temp";
var REPORTS = null;


function on(el, evt, fn){ 
  if(el.addEventListener) el.addEventListener(evt,fn,false); 
  else if(el.attachEvent) el.attachEvent('on'+evt,fn); else el['on'+evt]=fn; }

// ---------- Tabs ----------
function switchTab(tabId){
  var tabs = document.getElementById('tabs').getElementsByTagName('button');
  for (var i=0;i<tabs.length;i++){
    var t = tabs[i], target = t.getAttribute('data-target');
    var panel = document.getElementById(target);
    if (target === tabId){
      t.className = 'tab active';
      if (panel && panel.className.indexOf('tab-visible') === -1) panel.className += ' tab-visible';
    } else {
      t.className = 'tab';
      if (panel) panel.className = panel.className.replace(/\btab-visible\b/g,'');
    }
  }
}
function initTabs(){
  var tabs = document.getElementById('tabs').getElementsByTagName('button');
  for (var i=0;i<tabs.length;i++){
    (function(btn){
      var id = btn.getAttribute('data-target');
      if (btn.addEventListener) btn.addEventListener('click', function(){ switchTab(id); }, false);
      else if (btn.attachEvent) btn.attachEvent('onclick', function(){ switchTab(id); });
      else btn.onclick = function(){ switchTab(id); };
    })(tabs[i]);
  }
  switchTab('tab-params');
}
// call it robustly
if (window.addEventListener) window.addEventListener('load', initTabs, false);
else if (window.attachEvent) window.attachEvent('onload', initTabs);
else window.onload = initTabs;



function setText(el, txt){ 
  if ('textContent' in el) el.textContent = txt; 
  else el.innerText = txt; 
}


// Populate the <select> with distances (array of ints or strings)
function populateDistanceSelect(distList){
  var sel = document.getElementById('distSelect');
  if (!sel) return;
  // Clear options
  while (sel.options.length) sel.remove(0);

  // Add options
  for (var i=0;i<distList.length;i++){
    var d = String(distList[i]);
    var opt = document.createElement('option');
    opt.value = d;
    setText(opt, d);
    sel.appendChild(opt);
  }

}

function suavizar_bm(){
  
  var bm = document.getElementById('in_bm').value; 
  var col = document.getElementById('in_col').value; 
  var dist = document.getElementById('in_dist').value;  

  var out_col = document.getElementById('in_oc').value; 
  var out_bm = document.getElementById('in_obm').value; 


  // ################################################ // 

  var script = "suavizamiento_entry.py"
  
  var args = {
    bm: bm, 
    col: col, 
    dist: dist, 
    out_bm: out_bm, 
    out_col: out_col
  }

  var response = run_python(script, args); 

  dists = parseIntList(dist);
  populateDistanceSelect(dists)

  REPORTS = response["reports"]

  var table_json = REPORTS[dists[0]]
  renderTableFromJSON("reportTable", table_json);
  
  alert("Finished");

}


function btnBrowseBM1_onClick() {

  // search DmFileType in documentation for full list
  var table = BrowseAndSave(oScript.DmFileType.dmBlockModel, 'in_bm');
  columnPicklist(table, "in_col")

  var bm = document.getElementById('in_bm').value; 
  // var col = document.getElementById('in_col').value; 

  // var out_col = document.getElementById('in_oc'); 
  var out_bm = document.getElementById('in_obm'); 

  // out_col.value = bm + "_SUAV"
  out_bm.value = bm + "_SUAV"

}


function selCol_onSelect() {
  
  var col = document.getElementById('in_col').value; 
  var out_col = document.getElementById('in_oc'); 
  out_col.value = col + "_SUAV"

}


function selDist_onSelect(){

    var dist = document.getElementById('distSelect').value; 
    dist = parseInt(dist)

    var table_json = REPORTS[dist]
    renderTableFromJSON("reportTable", table_json);

}

on(window, 'load', initTabs);

</script>
</head>
<body>


  <style>
/* Base */
.wrap { max-width: 680px; margin: 32px auto; padding: 0 16px;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; color:#1a1a1a; }
.card { background:#fff; border:1px solid #e5e5e5; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.06); padding:20px; }
.card h1 { font-size:18px; margin:0 0 16px; font-weight:600; }
.form-table { width:100%; border-collapse:collapse; }
.form-table td { padding:10px 8px; vertical-align:middle; }
.form-table td:first-child { width:180px; color:#444; white-space:nowrap; font-weight:600; }
input[type="text"], select { width:100%; padding:8px 10px; border:1px solid #cfd8dc; border-radius:6px; box-sizing:border-box; font-size:14px; background:#fff; outline:none; }
input[type="text"]:focus, select:focus { border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,0.15); }
.inline { display:-ms-flexbox; display:flex; -ms-flex-align:center; align-items:center; }
.inline > * { margin-right:8px; }
.inline > *:last-child { margin-right:0; }
.btn { display:inline-block; padding:8px 14px; font-size:14px; font-weight:600; border-radius:6px; border:1px solid transparent; cursor:pointer; background:#2563eb; color:#fff; text-decoration:none; line-height:1.2; }
.btn:hover { opacity:.9; }
.btn:active { opacity:.85; }
.btn-secondary { background:#f3f4f6; color:#111827; border-color:#d1d5db; }
.actions { margin-top:16px; text-align:right; }
.hint { font-size:12px; color:#6b7280; margin-top:4px; }

/* Compact */
.wrap.compact { max-width:520px; }
.wrap.compact, .wrap.compact .card { font-size:13px; }
.wrap.compact .card { padding:12px; border-radius:6px; }
.wrap.compact .form-table td { padding:6px 6px; }
.wrap.compact .form-table td:first-child { width:150px; }
.wrap.compact input[type="text"], .wrap.compact select { padding:6px 8px; font-size:13px; border-radius:4px; height:30px; line-height:18px; }
.wrap.compact .inline > * { margin-right:6px; }
.wrap.compact .btn { padding:6px 10px; font-size:13px; border-radius:4px; }
.wrap.compact .actions { margin-top:12px; }
.wrap.compact .hint { font-size:11px; margin-top:2px; }

/* Tabs */
.tabs { display:block; margin:0 auto 10px; padding:0 16px; max-width:680px; }
.tabs.compact { max-width:520px; }
.tabbar { border-bottom:1px solid #e5e5e5; padding-top:4px; }
.tab { background:#f9fafb; border:1px solid #e5e5e5; border-bottom:none; padding:8px 12px; margin:0 6px -1px 0;
  border-top-left-radius:6px; border-top-right-radius:6px; cursor:pointer; font-weight:600; }
.tab.active { background:#fff; color:#111827; }
.tab-panel { display:none; }
.tab-visible { display:block; }

/* Table */
.table-wrap { overflow-x:auto; }
#reportTable { border-collapse:collapse; width:100%; font-family:Arial,"Segoe UI",Tahoma,sans-serif; font-size:13px; color:#1a1a1a; table-layout:auto; }
#reportTable thead th { background:#f3f4f6; color:#111827; text-align:left; padding:8px 10px; border-bottom:1px solid #d1d5db; white-space:nowrap; font-weight:700; }
#reportTable tbody td { padding:8px 10px; border-bottom:1px solid #e5e7eb; vertical-align:middle; }
#reportTable tbody tr:nth-child(odd) { background:#fafafa; }
#reportTable tbody tr:hover { background:#eef2ff; }
#reportTable .num { text-align:right; }
#reportTable .pct { text-align:right; }
#reportTable .mono { font-family:Consolas,"Courier New",monospace; }
</style>


  
    <!-- TAB HEADERS -->
  <div id="tabs" class="tabs compact">
    <div class="tabbar">
      <button type="button" class="tab active" data-target="tab-params">Parametros</button>
      <button type="button" class="tab" data-target="tab-report">Reporte</button>
    </div>
  </div>

  
  <!-- TAB 1: Parametros -->
<div id="tab-params" class="wrap compact tab-panel tab-visible"> 
   <div class="card">
      <h1>Parametros de Suavizamiento</h1>
      <table class="form-table" role="presentation">
        <tr>
          <td><label for="in_bm">Block Model</label></td>
          <td colspan="2">
            <div class="inline">
              <input type="text" id="in_bm" />
              <input type="button" id="btn_bm" class="btn btn-secondary" value="..." onclick="btnBrowseBM1_onClick();" title="Seleccionar Block Model" />
            </div>
            <div class="hint">Ruta del archivo del block model de entrada.</div>
          </td>
        </tr>
        <tr>
          <td><label for="in_col">Column</label></td>
          <td colspan="2">
            <select id="in_col" onchange="selCol_onSelect();">
              <option value="">...</option>
            </select>
            <div class="hint">Elija la columna a suavizar.</div>
          </td>
        </tr>
        <tr>
          <td><label for="in_dist">Distance</label></td>
          <td colspan="2">
            <input type="text" id="in_dist" value="10,20" />
            <div class="hint">Use comas para multiples distancias (ej.: 10,20).</div>
          </td>
        </tr>
        <tr>
          <td><label for="in_obm">Out Block Model</label></td>
          <td colspan="2">
            <input type="text" id="in_obm" />
            <div class="hint">Nombre del block model suavizado.</div>
          </td>
        </tr>
        <tr>
          <td><label for="in_oc">Out Column</label></td>
          <td colspan="2">
            <input type="text" id="in_oc" />
            <div class="hint">Nombre de la columna de salida.</div>
          </td>
        </tr>
      </table>
      <div class="actions">
        <button class="btn" onclick="suavizar_bm();">Suavizar</button>
      </div>
    </div>
  </div>

  <!-- TAB 2: Reporte -->
  <div id="tab-report"  class="wrap compact tab-panel"> 
    <div class="card">
      <h1>Reporte</h1>
      <div class="table-controls" style="margin:8px 0 12px;">
        <label for="distSelect" style="margin-right:6px;font-weight:600;">Distance:</label>
        <select id="distSelect" style="min-width:110px;height:30px;padding:6px 8px;" onchange="selDist_onSelect();"></select>
      </div>
      <div class="table-wrap">
        <table id="reportTable"></table>
      </div>
    </div>
  </div>

</body>
</html>